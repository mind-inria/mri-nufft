name: Docs

on:
  workflow_run:
    workflows: CI
    types:
      - completed


  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  makedocs:
    name: Deploy API Documentation
    runs-on: gpu
    if: ${{ contains(github.event.workflow_run.head_commit.message, 'docs_build')}} or ${{github.event.workflow_run.head_branch == 'master'}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get history and tags for SCM versioning to work
        run: |
          git fetch --prune --unshallow
          git fetch --depth=1 origin +refs/tags/*:refs/tags/*

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[doc]
          python -m pip install finufft
    
      - name: Install GPU related interfaces
        run: |
          export CUDA_BIN_PATH=/usr/local/cuda-11.8/
          export PATH=/usr/local/cuda-11.8/bin/:${PATH}
          export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64/:${LD_LIBRARY_PATH}
          pip install cupy-cuda11x
          pip install torch --index-url https://download.pytorch.org/whl/cu118
          python -m pip install gpuNUFFT cufinufft

      - name: Build API documentation
        run: |
          python -m sphinx docs docs_build

      - name: Display data
        run: ls -R
        working-directory: docs_build/_static

      - name: Get the badge from CI
        if: ${{ !contains(github.event.workflow_run.head_commit.message, 'docs_build')}}
        uses: actions/download-artifact@v4
        with:
          name: coverage_badge
          path: docs_build/_static
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Upload artifact
        id: artifact-upload-step
        uses: actions/upload-artifact@v4
        with:
          # Upload the docs
          name: docs
          path: 'docs_build'
          retention-days: 10